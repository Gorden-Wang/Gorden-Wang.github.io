/*! Generated by Clam: wechat 2016-04-11 14:09:50 */
!function(a,b){var c=function(){this.init()},d=location.href.split("?")[0];c.prototype={init:function(){var a=this;Wlib.wx.getJS(d,function(){a.cacheData(),a.cacheDom(),a.getContactList()})},cacheData:function(){var a=this;a.data={treatmentPlanId:Wlib.getRequestParam("treatmentPlanId"),userId:localStorage.getItem("userId"),treatmentPlanDetailId:Wlib.getRequestParam("treatmentPlanDetailId"),doc:Wlib.getRequestParam("doc"),dep:Wlib.getRequestParam("dep"),add:Wlib.getRequestParam("add"),time:Wlib.getRequestParam("time"),price:Wlib.getRequestParam("price")},a.data.CONID=""},cacheDom:function(){var a=this;a.dom={wrapper:b("#page"),loading:b("#loading"),tpl:b("#tpl")}},renderUI:function(){var a=this;a.dom.wrapper.html(juicer(a.dom.tpl.html(),a.data)),a.dom.loading.hide()},recacheDom:function(){var a=this;a.dom.con=b(".history-wrapper li"),a.dom.name=b("#name"),a.dom.idcode=b("#idcode"),a.dom.tel=b("#tel"),a.dom.btn=b(".btn")},getContactList:function(){var a=this;Wlib.SendRequestNew("treatOperate","findReserveProfiles",{userid:a.data.userId,firstResult:0,maxResults:3},function(b){0==b.errorCode&&(a.data.conList=b.value||[],a.renderUI(),a.recacheDom(),a.bindEvent())})},bindEvent:function(){var a=this;a.dom.con.on("click",function(){var c=b(this).find("div"),d=b(c).hasClass("radio_se");d?(b(c).removeClass("radio_se"),a.renderInput(this,!1),a.data.CONID="",a.dom.btn.addClass("dis")):(b(c).addClass("radio_se"),b(this).siblings().find("div").removeClass("radio_se"),a.renderInput(this,!0),a.data.CONID=b(this).attr("data-id"),a.dom.btn.removeClass("dis"))}),b("input").on("input",function(){var c=a.compare();a.dom.con.find("div").removeClass("radio_se"),c.res?(b("li[data-id='"+c.id+"'").find("div").addClass("radio_se"),a.data.CONID=c.id):a.data.CONID=""}),a.dom.btn.on("click",function(){({treatmentPlanId:Wlib.getRequestParam("treatmentPlanId"),userId:localStorage.getItem("userId"),treatmentPlanDetailId:Wlib.getRequestParam("treatmentPlanDetailId"),reserveId:a.data.CONID});b(this).hasClass("dis")||a.addContact(function(){a.addOrder()})})},addOrder:function(){var a=this,b={userid:a.data.userId,treatmentPlanDetailId:Wlib.getRequestParam("treatmentPlanDetailId"),profileId:a.data.CONID};Wlib.SendRequestNew("treatOperate","orderTreatmentPlan",b,function(b){if(0==b.errorCode){var c=b.value.id,d={userid:localStorage.getItem("userId"),orderid:c,amount:100*parseFloat(a.data.price),channel:"weixin",clientIp:"127.0.0.1",openid:localStorage.getItem("openid")};Wlib.SendRequestNew("pay","payOrder",d,function(a){wx.config({debug:!1,appId:a.value.result.appId,timestamp:a.value.result.timeStamp,nonceStr:a.value.result.nonceStr,signature:a.value.paySign,jsApiList:["chooseWXPay"]}),wx.ready(function(){wx.chooseWXPay({timestamp:a.value.result.timeStamp,nonceStr:a.value.result.nonceStr,"package":a.value.result["package"],signType:"MD5",paySign:a.value.result.paySign,success:function(b){"chooseWXPay:ok"==b.errMsg?location.href="../../pages/paysucc/index.html?orderId="+a.value.orderid+"&userId="+a.value.userid:(alert("\u652f\u4ed8\u5931\u8d25"),location.href="../../pages/orderdetail/index.html?orderId="+a.value.orderid)},cancel:function(b){location.href="../../pages/orderdetail/index.html?orderId="+a.value.orderid}})})})}else Wlib.tips(b.message)})},addContact:function(a){var b=this,c={name:encodeURIComponent(b.dom.name.val()),phone:b.dom.tel.val(),idNumber:b.dom.idcode.val(),userid:b.data.userId,remark:""},d=/^[\u2E80-\u9FFF]+$/;if(!d.test(b.dom.name.val())||b.dom.name.val().length<2||b.dom.name.val().length>4)return void Wlib.tips("\u59d3\u540d\u8bf7\u8f93\u51652-4\u4f4d\u6c49\u5b57");var e=/^1\d{10}$/;return e.test(b.dom.tel.val())?b.data.CONID?void(a&&a()):void Wlib.SendRequestNew("treatOperate","addReserveProfileIfExist",c,function(c){0==c.errorCode?(b.data.CONID=c.value.id,a&&a()):Wlib.tips(c.message)}):void Wlib.tips("\u8bf7\u8f93\u5165\u6b63\u786e\u7684\u624b\u673a\u53f7\u7801")},renderInput:function(a,c){var d=this,e=b(a).find(".l-name").text(),f=b(a).find(".l-code").text(),g=b(a).find(".l-tel").text();c?(d.dom.name.val(e),d.dom.idcode.val(f),d.dom.tel.val(g)):(d.dom.name.val(""),d.dom.idcode.val(""),d.dom.tel.val(""))},compare:function(){for(var a=this,c={userName:a.dom.name.val(),phone:a.dom.tel.val(),idNumber:a.dom.idcode.val()},d=a.data.conList,e=!1,f="",g=0;g<d.length;g++)if(b.trim(c.userName)==d[g].userName&&b.trim(c.idNumber)==d[g].idNumber&&b.trim(c.phone)==d[g].phone){e=!0,f=d[g].id;break}return c.userName&&c.phone&&c.idNumber&&a.dom.btn.hasClass("dis")&&a.dom.btn.removeClass("dis"),{res:e,id:f}}};new c}(window,$);